<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Do it in code! | WordCamp Vancouver 2016</title>

    <link rel="stylesheet" href="../reveal.js/css/reveal.css">
    <link rel="stylesheet" href="../css/rexrana-dark.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/qtcreator_dark.min.css">

    <!-- Printing and PDF exports -->
    <script src="../js/print-pdf.js"></script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section class="title-slide">

          <div class="center-block img-small">
            <img src="wcyvr2016-logo-white.png" alt="WordCamp Vancouver 2016" class="fit">
          </div>

          <header>
            <h1>Do it in code!</h1>
            <h2>A guide to creating a custom site structure plugin in WordPress.</h2>
          </header>
          <div class="presenter">
            <p>Presented by:</p>
            <h3>Peter Hebert</h3>
            <p>
              Rex Rana Design and Development Ltd.
            </p>
          </div>
        </section>

        <section>
          <h1>Why a custom plugin?</h1>
          <ul>
            <li>
              Because site functionality should live in code, not the database
            </li>
            <li>
              Manage code in version control system (git, svn)</li>
            <li>Code Portability / Deployment
              <ul>
                <li>
                  dev / staging / production
                </li>
                <li>
                  re-use for multiple websites / different clients
                </li>
              </ul>
            </li>
          </ul>

        </section>



        <section>
          <h1>WordPress core functionality</h1>
          <p>
            API in core for custom post types, metaboxes, fields, and taxonomy
          </p>
          <ul>
            <li>
              Not very easy to use
            </li>
            <li>
              You have to do all the heavy lifting
              <ul>
                <li>create, read, update and delete (CRUD) functions</li>
                <li>
                  Callback functions to display fields in admin
                </li>
                <li>
                  Sanitization / validation functions
                </li>
                <li>
                  nonces
                </li>
              </ul>
            </li>
            <li>
              It's a lot to remember - time could be better spent
            </li>

          </ul>

        </section>

        <section>
          <h1>Sample metabox - WordPress core</h1>
          <p>
            1 metabox with 3 fields =
            <strong>162</strong>
            lines of code.
          </p>
          <ul>
            <li>
              post type: film
            </li>
            <li>
              metabox: fim info
            </li>
            <li>
              fields: release date, duration, director
            </li>
          </ul>
          <pre>
            <code class="hljs php">&lt;?php&#10;&#10;/* Fire our meta box setup function on the post editor screen. */&#10;add_action(&apos;load-post.php&apos;, &apos;my_post_meta_boxes_setup&apos;);&#10;add_action(&apos;load-post-new.php&apos;, &apos;my_post_meta_boxes_setup&apos;);&#10;&#10;/* Meta box setup function. */&#10;function my_post_meta_boxes_setup()&#10;{&#10;&#10;  /* Add meta boxes on the &apos;add_meta_boxes&apos; hook. */&#10;  add_action(&apos;add_meta_boxes&apos;, &apos;my_add_post_meta_boxes&apos;);&#10;&#10;  /* Save post meta on the &apos;save_post&apos; hook. */&#10;  add_action(&apos;save_post&apos;, &apos;my_save_post_class_meta&apos;, 10, 2);&#10;}&#10;&#10;/* Create one or more meta boxes to be displayed on the post editor screen. */&#10;function my_add_post_meta_boxes()&#10;{&#10;    add_meta_box(&#10;    &apos;film-info&apos;,      // Unique ID&#10;    esc_html__(&apos;Film Info&apos;, &apos;structure&apos;),    // Title&#10;    &apos;film_info_meta_box&apos;,   // Callback function&#10;    &apos;film&apos;,         // Admin page (or post type)&#10;    &apos;normal&apos;,         // Context&#10;    &apos;default&apos;         // Priority&#10;  );&#10;}&#10;&#10;/* Display the post meta box. */&#10;function film_info_meta_box($object, $box) {  ?&gt;&#10;  &lt;?php wp_nonce_field(basename(__FILE__), &apos;film_info_nonce&apos;); ?&gt;&#10;  &lt;table class=&quot;form-table&quot;&gt;&#10;  &Tab;&Tab;&lt;tbody&gt;&#10;        &lt;tr class=&quot;form-field&quot;&gt;&#10;  &Tab;&Tab;&Tab;&lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;release-date&quot;&gt;&lt;?php _e(&apos;Release Date&apos;, &apos;structure&apos;); ?&gt;&lt;/label&gt;&lt;/th&gt;&#10;  &Tab;&Tab;&Tab;&lt;td&gt;&#10;          &lt;input style=&quot;max-width: 12em&quot; class=&quot;datepicker&quot; type=&quot;text&quot; name=&quot;release-date&quot; id=&quot;release-date&quot; value=&quot;&lt;?php echo esc_attr(get_post_meta($object-&gt;ID, &apos;release_date&apos;, true)); ?&gt;&quot; /&gt;&#10;          &lt;p class=&quot;description&quot;&gt;&lt;?php _e(&apos;Date the film was released.&apos;, &apos;structure&apos;); ?&gt;&lt;/p&gt;&#10;        &lt;/td&gt;&#10;  &Tab;&Tab;&lt;/tr&gt;&#10;      &lt;tr class=&quot;form-field&quot;&gt;&#10;        &lt;th scope=&quot;row&quot;&gt;&#10;          &lt;label for=&quot;duration&quot;&gt;&lt;?php _e(&apos;Duration&apos;, &apos;structure&apos;); ?&gt;&lt;/label&gt;&#10;        &lt;/th&gt;&#10;        &lt;td&gt;&#10;          &lt;input style=&quot;max-width: 6em&quot; type=&quot;number&quot; name=&quot;duration&quot; id=&quot;duration&quot; value=&quot;&lt;?php echo esc_attr(get_post_meta($object-&gt;ID, &apos;duration&apos;, true)); ?&gt;&quot; /&gt;&#10;          &lt;p class=&quot;description&quot;&gt;&lt;?php _e(&apos;Length of film in minutes.&apos;, &apos;structure&apos;); ?&gt;&lt;/p&gt;&#10;        &lt;/td&gt;&#10;      &lt;/tr&gt;&#10;      &lt;tr class=&quot;form-field&quot;&gt;&#10;        &lt;th scope=&quot;row&quot;&gt;&#10;          &lt;label for=&quot;director&quot;&gt;&lt;?php _e(&apos;Director&apos;, &apos;structure&apos;); ?&gt;&lt;/label&gt;&#10;        &lt;/th&gt;&#10;        &lt;td&gt;&#10;          &lt;input type=&quot;text&quot; name=&quot;director&quot; id=&quot;director&quot; value=&quot;&lt;?php echo esc_attr(get_post_meta($object-&gt;ID, &apos;director&apos;, true)); ?&gt;&quot; /&gt;&#10;        &lt;/td&gt;&#10;      &lt;/tr&gt;&#10;  &Tab;&Tab;&Tab;&lt;/tbody&gt;&#10;      &lt;/table&gt;&#10;&lt;?php&#10;}&#10;&#10;/* Save the meta box&apos;s post metadata. */&#10;function my_save_post_class_meta($post_id, $post)&#10;{&#10;&#10;  /* Verify the nonce before proceeding. */&#10;  if (!isset($_POST[&apos;film_info_nonce&apos;]) || !wp_verify_nonce($_POST[&apos;film_info_nonce&apos;], basename(__FILE__))) {&#10;      return $post_id;&#10;  }&#10;&#10;  /* Get the post type object. */&#10;  $post_type = get_post_type_object($post-&gt;post_type);&#10;&#10;  /* Check if the current user has permission to edit the post. */&#10;  if (!current_user_can($post_type-&gt;cap-&gt;edit_post, $post_id)) {&#10;      return $post_id;&#10;  }&#10;&#10;  // RELEASE DATE&#10;  /* Get the posted data and sanitize it. */&#10;  $new_release_date = ( isset( $_POST[&apos;release-date&apos;] ) ? preg_replace(&quot;([^0-9/])&quot;, &quot;&quot;, $_POST[&apos;release-date&apos;]) : &apos;&apos; );&#10;&#10;  /* Get the meta value of the custom field key. */&#10;  $old_release_date = get_post_meta($post_id, &apos;release_date&apos;, true);&#10;&#10;  /* If a new meta value was added and there was no previous value, add it. */&#10;  if ($new_release_date &amp;&amp; &apos;&apos; == $old_release_date) {&#10;      add_post_meta($post_id, &apos;release_date&apos;, $new_release_date, true);&#10;  }&#10;&#10;  /* If the new meta value does not match the old value, update it. */&#10;  elseif ($new_release_date &amp;&amp; $new_release_date != $old_release_date) {&#10;      update_post_meta($post_id, &apos;release_date&apos;, $new_release_date);&#10;  }&#10;&#10;  /* If there is no new meta value but an old value exists, delete it. */&#10;  elseif (&apos;&apos; == $new_release_date &amp;&amp; $old_release_date) {&#10;      delete_post_meta($post_id, &apos;release_date&apos;, $old_release_date);&#10;  }&#10;&#10;// Duration&#10;/* Get the posted data and sanitize it. */&#10;  $new_duration = ( isset( $_POST[&apos;duration&apos;] ) ? absint( $_POST[&apos;duration&apos;] ) : &apos;&apos; );&#10;&#10;  /* Get the meta value of the custom field key. */&#10;  $old_duration = get_post_meta( $post_id, &apos;duration&apos;, true );&#10;&#10;  /* If a new meta value was added and there was no previous value, add it. */&#10;  if ( $new_duration &amp;&amp; &apos;&apos; == $old_duration ) {&#10;    add_post_meta( $post_id, &apos;duration&apos;, $new_duration, true );&#10;  }&#10;  /* If the new meta value does not match the old value, update it. */&#10;  elseif ( $new_duration &amp;&amp; $new_duration != $old_duration ) {&#10;    update_post_meta( $post_id, &apos;duration&apos;, $new_duration );&#10;  }&#10;  /* If there is no new meta value but an old value exists, delete it. */&#10;  elseif ( &apos;&apos; == $new_duration &amp;&amp; $old_duration ) {&#10;    delete_post_meta( $post_id, &apos;duration&apos;, $old_duration );&#10;  }&#10;&#10;// Director&#10;/* Get the posted data and sanitize it. */&#10;  $new_director = ( isset( $_POST[&apos;director&apos;] ) ? sanitize_text_field( $_POST[&apos;director&apos;] ) : &apos;&apos; );&#10;&#10;  /* Get the meta value of the custom field key. */&#10;  $old_director = get_post_meta( $post_id, &apos;director&apos;, true );&#10;&#10;  /* If a new meta value was added and there was no previous value, add it. */&#10;  if ( $new_director &amp;&amp; &apos;&apos; == $old_director ) {&#10;    add_post_meta( $post_id, &apos;director&apos;, $new_director, true );&#10;  }&#10;  /* If the new meta value does not match the old value, update it. */&#10;  elseif ( $new_director &amp;&amp; $new_director != $old_director ) {&#10;    update_post_meta( $post_id, &apos;director&apos;, $new_director );&#10;  }&#10;  /* If there is no new meta value but an old value exists, delete it. */&#10;  elseif ( &apos;&apos; == $new_director &amp;&amp; $old_director ) {&#10;    delete_post_meta( $post_id, &apos;director&apos;, $old_director );&#10;  }&#10;&#10;}&#10;&#10;// Register datepicker ui for properties&#10;function my_structure_admin_javascript(){&#10;    global $post;&#10;    if( $post-&gt;post_type == &apos;film&apos; &amp;&amp; is_admin() ) {&#10;      wp_enqueue_script( &apos;load-datepicker&apos;, MY_PLUGIN_URL.&apos;admin.js&apos;, array(&apos;jquery&apos;, &apos;jquery-ui-datepicker&apos;) );&#10;    }&#10;}&#10;add_action(&apos;admin_print_scripts&apos;, &apos;my_structure_admin_javascript&apos;);&#10;&#10;// Register ui styles for properties&#10;function my_structure_admin_styles(){&#10;    global $post;&#10;    if($post-&gt;post_type == &apos;film&apos; &amp;&amp; is_admin()) {&#10;      wp_enqueue_style(&apos;jquery-ui-css&apos;, &apos;http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/themes/smoothness/jquery-ui.css&apos;);&#10;    }&#10;}&#10;add_action(&apos;admin_print_styles&apos;, &apos;my_structure_admin_styles&apos;);&#10;</code>
          </pre>
<aside class="notes">
  Show wp-fields.php in code editor
</aside>
        </section>

        <section>
          <h1>Thankfully, there is a better way!</h1>
          <p>
            Many tools exist that greatly simplify creating custom site structure:
          </p>
          <ul>
            <li class="fragment">
              Plugins (Advanced Custom Fields, Pods, Toolset, etc.)
              <ul>
                <li class="fragment">
                  All have some type of export to code functionality
                </li>
              </ul>
            </li>
            <li class="fragment">
              Developer libraries:
              <a href="https://github.com/WebDevStudios/CMB2">CMB2</a>
            </li>
            <li class="fragment">
              Code Generators:
              <a href="https://generatewp.com/">GenerateWP</a>
            </li>
          </ul>

        </section>
        <section>
          <h1>GUI-based structure plugins</h1>
          <p>
            Create your structure in the admin, then export to code.
          </p>
          <ul>
            <li class="fragment">
              <a href="https://www.advancedcustomfields.com/">Advanced Custom Fields</a><br/>
              export to XML, PHP, JSON
            </li>
            <li class="fragment">
              <a href="http://pods.io/">Pods</a>
              framework
              <ul>
                <li>
                  Migrate: Packages
                </li>
                <li>
                  Pods Deploy - uses WordPress REST API (beta)
                </li>
              </ul>

            </li>
            <li class="fragment">
              <a href="https://wp-types.com/">Toolset</a>
              <ul>
                <li>
                  <a href="https://wp-types.com/documentation/embedded-toolset/">Embedded Toolset</a>
                  / Packager
                </li>
              </ul>
            </li>

          </ul>

        </section>
        <section>
          <h1>Developer library:
            <a href="https://github.com/WebDevStudios/CMB2">CMB2</a>
          </h1>

          <ul>
            <li>
              Toolkit for building metaboxes, custom fields, and forms
            </li>
            <li>
              takes care of all the hard stuff for you
            </li>
            <li>
              Declare metaboxes and fields using arrays of parameters
            </li>
            <li>
              32 field types included, with API to declare your own
            </li>
            <li>
              Use on Post Types, Options Pages, User Profiles
              <ul>
                <li>
                  even on the front end of your site
                </li>

              </ul>
            </li>
          </ul>
        </section>
        <section>
          <h1>CMB2 Sample Metabox &amp; field</h1>
          <pre>
    <code class="hljs php">
      add_action('cmb2_init', 'phs_films_metabox');
      function phs_films_metabox()
      {
        $prefix = '_phs_';

        $films = new_cmb2_box(array(
        'id'           =&gt; $prefix . 'films',
        'title'        =&gt; __('Film Info', 'phs'),
        'object_types' =&gt; array('film'),
        'context'      =&gt; 'normal',
        'priority'     =&gt; 'default',
        ));

        $films-&gt;add_field(array(
        'name'    =&gt; __('Release Date', 'phs'),
        'id'      =&gt; $prefix . 'release_date',
        'type'    =&gt; 'text_date',
        'default' =&gt; 'now',
        'desc'    =&gt; __('select the date the film was released', 'phs'),
        ));
      }
    </code>
  </pre>
        </section>
        <section>

          <h1>
            <a href="https://generatewp.com/">GenerateWP</a>
          </h1>
          <p>
            Form-based tool - generates code compliant with WordPress coding standards
          </p>
          <iframe src="https://generatewp.com/post-type/?clone=A3vVwrM#tab-general" width="1200" height="720"></iframe>

        </section>
        <section>
          <h1>
            <a href="https://generatewp.com/">GenerateWP</a>
          </h1>
          <ul>

            <li>
              Select a tool, fill in the form, generate the code
            </li>
            <li>
              Copy ready-to-use code directly to your plugin.
            </li>
            <li>
              Generators:
              <ul>
                <li>
                  <strong>Content</strong>: Shortcodes, Post Types, Meta Boxes/Fields, Taxonomy, Term Meta, Post Status
                </li>
                <li>
                  <strong>Admin</strong>: Toolbars, Dashboard Widgets, Quicktags, oEmbed Providers, User Contact Methods
                </li>
                <li>
                  <strong>Core</strong>: Hooks, Plugin Readme, Schedule Cron Job Event, Register Scripts &amp; Styles
                </li>
                <li>
                  <strong>Design</strong>: Menus, Sidebars, Widgets, Theme Support, Theme Default Headers
                </li>
                <li>
                  <strong>Queries</strong>: WP_Query, WP_User_Query, WP_Comment_Query, WP_Term_Query, WP_Site_Query
                </li>
              </ul>
            </li>
          </ul>
        </section>
        <section>
          <h1>Putting it all together</h1>
          <ul>
            <li>
              Download ACF or CMB2 and save it to a subdirectory within your plugin
            </li>
            <li>
              Include ACF or CMB2 in your plugin's main PHP file (my-custom-structure.php)<br/>
              <pre>
        <code class="hljs php">/* Advanced Custom Fields */
include_once('lib/advanced-custom-fields/acf.php');

/* OR CMB2 */
include_once('lib/cmb2/init.php');
        </code>
      </pre>
            </li>
          </ul>

          <p class="small">
            * Premium plugins require a ACF Pro licence
          </p>
        </section>

        <section>
          <h1>Resources</h1>
          <ul>
            <li>
              <a href="http://storyftw.com/cmb2-metabox-strikes-back">CMB2: THE METABOX STRIKES BACK</a>
              (Justin Sternberg)
            </li>
            <li>
              <a href="https://docs.google.com/spreadsheets/d/1mSqienVYxLopTFGLPK0lGCJst2knKzXDtLQRgwjeBN8/edit#gid=3">Plugin comparison - Content Types / Custom Fields</a>
              (Google spreadsheet)
            </li>
            <li>
              Mea vidit consul molestie ut.
            </li>
          </ul>

        </section>

        <section>
          <header>
            <h1>Find me online</h1>
          </header>
          <p class="row">
            <span class="icons">
              <img src="../font-awesome-icons/white/svg/link.svg" alt="Rex Rana website" class="icon"/>
            </span>
            <span class="float-left">
              <a href="https://rexrana.ca">rexrana.ca</a><br/>
              <a href="http://peterhebert.com">peterhebert.com</a>
            </span>
          </p>
          <p class="row">
            <span class="icons">
              <img src="../font-awesome-icons/white/svg/twitter.svg" alt="Twitter" class="icon"/>
            </span>
            <span class="float-left">
              @RexRanaDesign<br/>
              @peter_hebert

            </span>
          </p>

          <p class="row">
            <span class="icons">
              <img src="../font-awesome-icons/white/svg/wordpress.svg" alt="WordPress.org" class="icon"/>
              <img src="../font-awesome-icons/white/svg/drupal.svg" alt="Drupal.org" class="icon"/>
              <img src="../font-awesome-icons/white/svg/github.svg" alt="GitHub" class="icon"/>
              <img src="../font-awesome-icons/white/svg/linkedin.svg" alt="LinkedIn" class="icon"/>
            </span>
            <span class="float-left">
              peterhebert
            </span>
          </p>

        </section>
      </div>
      <div class="brand" id="logo-id"><img class="logo" src="../img/frog-king-head-white.svg">
        Rex Rana</div>
    </div>

    <script src="../reveal.js/lib/js/head.min.js"></script>
    <script src="../reveal.js/js/reveal.js"></script>
    <!-- initialize reveal.js -->
    <script src="../js/reveal-init.js"></script>
  </body>
</html>
